<!DOCTYPE html>
<html lang="en">
<head>
        <title>Shane Dowling : Simple ubuntu backup to S3</title>
        <meta charset="utf-8" />
        <link rel="stylesheet" href="./theme/css/main.css" type="text/css" />
        <link href="https://shanedowling.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Shane Dowling ATOM Feed" />

        <!--[if IE]>
                <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

        <!--[if lte IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="./css/ie.css"/>
                <script src="./js/IE8.js" type="text/javascript"></script><![endif]-->

        <!--[if lt IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="./css/ie6.css"/><![endif]-->

</head>

<body>
        
<header>
    <h1><a href="." id="site-title">Shane Dowling </a> :
        <a href="./simple-ubuntu-backup-to-s3-c3f3b7070208.html" id="page-title">Simple ubuntu backup to S3</a></h1>
<time datetime="2012-01-14T00:00:00+00:00">Sat 14 January 2012</time></header>
<article>
    <p>After browsing the web for ages to find a decent solution to backup my
server to amazon s3 I finally came across one and I'm just throwing it
up here. So basically all I need it to do was backup my sites(filesystem and mysql databases) and some config for lighttpd.</p>
<p>The post I'm basing this off is <a href="http://sdykman.com/blog/backing-drupal-sites-automysqlbackup-and-duplicity">here</a>.</p>
<ol>
<li>Install automysqlbackup using apt</li>
</ol>
<p>sudo apt-get install automysqlbackup</p>
<ol>
<li>Run automysqlbackup as root(just to give it a test)</li>
</ol>
<p>sudo automysqlbackup</p>
<ol>
<li>
<p>Double check the databases are being backed up you should see daily,
weekly and monthly under /var/lib/automysqlbackup with the appropriate
databases.</p>
</li>
<li>
<p>Now use this script to backup all the specific folders you want.</p>
</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="w"> </span><span class="c1"># Export some ENV variables so you don&#39;t have to type anything</span>
<span class="w"> </span><span class="nb">export</span><span class="w"> </span><span class="nv">AWS_ACCESS_KEY_ID</span><span class="o">=</span>
<span class="w"> </span><span class="nb">export</span><span class="w"> </span><span class="nv">AWS_SECRET_ACCESS_KEY</span><span class="o">=</span>
<span class="w"> </span><span class="nb">export</span><span class="w"> </span><span class="nv">PASSPHRASE</span><span class="o">=</span>
<span class="w"> </span><span class="c1"># Your GPG key</span>
<span class="w"> </span><span class="nv">GPG_KEY</span><span class="o">=</span><span class="p">;</span>
<span class="w"> </span><span class="c1"># The source of your backup</span>
<span class="w"> </span><span class="nv">SOURCE</span><span class="o">=</span>/
<span class="w"> </span><span class="c1"># The destination</span>
<span class="w"> </span><span class="c1"># Note that the bucket need not exist</span>
<span class="w"> </span><span class="c1"># but does need to be unique amongst all</span>
<span class="w"> </span><span class="c1"># Amazon S3 users. So, choose wisely.</span>
<span class="w"> </span><span class="nv">DEST</span><span class="o">=</span>s3+http://
<span class="w"> </span><span class="c1"># The duplicity command and options</span>
<span class="w"> </span>duplicity
<span class="w"> </span>—<span class="w"> </span>encrypt-key<span class="o">=</span><span class="si">${</span><span class="nv">GPG_KEY</span><span class="si">}</span>
<span class="w"> </span>—<span class="w"> </span>sign-key<span class="o">=</span><span class="si">${</span><span class="nv">GPG_KEY</span><span class="si">}</span>
<span class="w"> </span>—<span class="w"> </span><span class="nv">volsize</span><span class="o">=</span><span class="m">250</span>
<span class="w"> </span>—<span class="w"> </span><span class="nv">include</span><span class="o">=</span>/var/www
<span class="w"> </span>—<span class="w"> </span><span class="nv">include</span><span class="o">=</span>/home
<span class="w"> </span>—<span class="w"> </span><span class="nv">include</span><span class="o">=</span>/etc/lighttpd
<span class="w"> </span>—<span class="w"> </span><span class="nv">include</span><span class="o">=</span>/var/lib/automysqlbackup
<span class="w"> </span>—<span class="w"> </span><span class="nv">exclude</span><span class="o">=</span>/**
<span class="w"> </span><span class="si">${</span><span class="nv">SOURCE</span><span class="si">}</span><span class="w"> </span><span class="si">${</span><span class="nv">DEST</span><span class="si">}</span>
<span class="w"> </span><span class="c1"># Reset the ENV variables. Don&#39;t need them sitting around</span>
<span class="w"> </span><span class="nb">export</span><span class="w"> </span><span class="nv">AWS_ACCESS_KEY_ID</span><span class="o">=</span>
<span class="w"> </span><span class="nb">export</span><span class="w"> </span><span class="nv">AWS_SECRET_ACCESS_KEY</span><span class="o">=</span>
<span class="w"> </span><span class="nb">export</span><span class="w"> </span><span class="nv">PASSPHRASE</span><span class="o">=</span>
</code></pre></div>

<ol>
<li>
<p>Add your own specific access key stuff and give it a test</p>
</li>
<li>
<p>Then add it to a cronjob</p>
</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span>*<span class="w"> </span>*<span class="w"> </span>*<span class="w"> </span>/usr/sbin/automysqlbackup<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>/root/s3_backup
</code></pre></div>
</article>

        <footer>
            <nav>
                <ul>
                    <li><a href="./pages/contact.html">Contact</a></li>
                    <li>:: <a href="./categories.html">Categories</a></li>
                </ul>
            </nav>
        </footer>

</body>
</html>