<!DOCTYPE html>
<html lang="en">
<head>
        <title>Shane Dowling : SugarCRM — Searches with data from indirectly related modules</title>
        <meta charset="utf-8" />
        <link rel="stylesheet" href="./theme/css/main.css" type="text/css" />
        <link href="https://shanedowling.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Shane Dowling ATOM Feed" />

        <!--[if IE]>
                <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

        <!--[if lte IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="./css/ie.css"/>
                <script src="./js/IE8.js" type="text/javascript"></script><![endif]-->

        <!--[if lt IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="./css/ie6.css"/><![endif]-->

</head>

<body>
        
<header>
    <h1><a href="." id="site-title">Shane Dowling </a> :
        <a href="./sugarcrm-searches-with-data-from-indirectly-related-modules-ec204005f7b3.html" id="page-title">SugarCRM — Searches with data from indirectly related modules</a></h1>
<time datetime="2014-04-17T00:00:00+00:00">Thu 17 April 2014</time></header>
<article>
    <p>Building modules in SugarCRM can cause you to create a boatload of
unnecessary relationships, simply because it's convenient to do so.
Maybe you'd have a relationship where A relates to B and B to C but
you'd like to search for all A module records that relate to C. One
option is to maybe related A to C and maintain the relationships by
using hooks on save to preserve the A-C relationship. That way you could
leverage Sugar relate fields and indirect searching, but that can be a
messy choice that adds a lot of complexity if overused.</p>
<p>The alternative is to keep the relationship structure as it is and add a
new field to the search and build a custom subselect statement. For this
example we're adding a Drop-Down to Accounts to allow a user to search
which Accounts are indirectly related to Performers via Events. Say we
wish to present a drop-down on Accounts of all performers and if you
search, it will return all Accounts attached to the specified Performer.</p>
<h3>Get the data for the drop-down</h3>
<p>In custom/modules/Accounts/getCustomDropDown.php</p>
<div class="highlight"><pre><span></span><code><span class="x">require_once(&quot;modules/Performers/Performers.php&quot;);</span>

<span class="x">function galleryPerformers($focus, $field, $value, $view, $tabindex=&#39;0&#39;) {</span>
<span class="x"> $performersBean = BeanFactory::getBean(&#39;Performers&#39;);</span>
<span class="x"> $performers = $performersBean-&gt;get_full_list();</span>
<span class="x"> $html = &quot; — &quot;;</span>
<span class="x"> $selected_performer = $_REQUEST[&#39;performer_type_search&#39;]; // Or whatever dom id your drop-down has</span>
<span class="x"> foreach($performers as $performer) {</span>
<span class="x"> $html .= &quot; if($selected_performer == $performer-&gt;id) { // Props to Igor who flagged this in the comments!</span>
<span class="x"> $html .= &quot;selected&quot;;</span>
<span class="x"> }</span>
<span class="x"> $html .=&quot; value=&#39;{$performer-&gt;id}&#39;&gt;{$performer-&gt;name}&quot;;</span>
<span class="x"> }</span>
<span class="x"> return $html;</span>
<span class="x"> }</span>
<span class="x"> ```</span>

<span class="x">### Present the drop-down on the accounts search</span>

<span class="x">Note This has to go into modules/Accounts(I know, I know), but this had</span>
<span class="x">to break updatability to work otherwise this will wipe with a quick</span>
<span class="x">repair/rebuild(if you put it in custom). If you find an alternative</span>
<span class="x">solution put it here.</span>

<span class="x">So in modules/Accounts/metadata/vardefs.php</span>
<span class="x">```php</span>
<span class="x">$dictionary[&quot;Account&quot;][&quot;fields&quot;][&quot;performer_type_search&quot;] = array(</span>
<span class="x"> &#39;name&#39; =&gt; &#39;test&#39;,</span>
<span class="x"> &#39;vname&#39; =&gt; &#39;test&#39;,</span>
<span class="x"> &#39;type&#39; =&gt; &#39;varchar&#39;, // function to call that will return html that will be inserted</span>
<span class="x"> &#39;function&#39; =&gt; array(</span>
<span class="x"> &#39;name&#39; =&gt; &#39;galleryPerformer&#39;,</span>
<span class="x"> &#39;returns&#39; =&gt; &#39;html&#39;,</span>
<span class="x"> &#39;include&#39; =&gt; &#39;custom/modules/Accounts/getCustomDropDown.php&#39;),</span>
<span class="x"> &#39;required&#39; =&gt; false,</span>
<span class="x"> &#39;do_report&#39; =&gt; false,</span>
<span class="x"> &#39;reportable&#39; =&gt; false,</span>
<span class="x"> &#39;comment&#39; =&gt; &#39;Performer Searching&#39;,</span>
<span class="x"> &#39;source&#39; =&gt; &#39;non-db&#39;</span>
<span class="x"> );</span>
</code></pre></div>

<h3>Extend the search</h3>
<p>Now that you have your drop-down working you need to extend the search
to do what you need.</p>
<p>custom/modules/Accounts/metadata/SearchFields.php</p>
<div class="highlight"><pre><span></span><code><span class="x">&#39;performer_search&#39; =&gt; array(</span>
<span class="x"> &#39;query_type&#39; =&gt; &#39;default&#39;,</span>
<span class="x"> &#39;operator&#39; =&gt; &#39;subquery&#39;,</span>
<span class="x"> &#39;subquery&#39; =&gt; &#39;SELECT accounts.id FROM accounts LEFT JOIN account_event acc_evt ON acc_evt.\`account_ida\` = accounts.id LEFT JOIN performers_event per_evt ON pvt_evt.\`event_idb\` = acc_evt.\`performers_idb\` WHERE acc_evt.deleted = 0 AND pvt_evt.deleted = 0 AND accounts.deleted = 0 AND pvt_evt.\`fair_ida\` LIKE&#39;,</span>
<span class="x"> &#39;db_field&#39; =&gt; array(&#39;id&#39;),</span>
<span class="x"> &#39;type&#39; =&gt; &#39;enum&#39;, ),</span>
</code></pre></div>

<p>Now this query probably looks a little weird, but basically it's an
almost pseudocode type query that simply connected the two lookup tables
between Accounts and Events then Events and Performers and does the
where on the performers id.</p>
<p>Note the LIKE in the query. Even if you're querying IDs, Sugar stupidly
passes in the value with a % at the end. So make sure this is LIKE
statement.</p>
</article>

        <footer>
            <nav>
                <ul>
                    <li><a href="./pages/contact.html">Contact</a></li>
                    <li>:: <a href="./categories.html">Categories</a></li>
                </ul>
            </nav>
                <p id="theme-credit"><a href="http://mathieu.agopian.info/mnmlist/theme.html">Thème mnmlist</a></p>
        </footer>

</body>
</html>