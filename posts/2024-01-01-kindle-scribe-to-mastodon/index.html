<!doctype html><html lang=en dir=auto><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=8080&amp;path=livereload" data-no-instant defer></script><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="noindex, nofollow"><title>Kindle Scribe to Mastodon | Shane Dowling</title><meta name=keywords content><meta name=description content="
Kindle Scribe to Mastodon
Over the holidays, I put together a fun little project to put out status updates on Mastodon. Of course, I used some spare time to make this as overly-engineered as possible.
Stringing It All Together
I wanted this to be event-driven and serverless and to give me some experience toying with Terraform in AWS. Thankfully, what would be the most computationally challenging part is already handled by Amazon. The Kindle Scribe provides a means to convert a note to text and then email it to myself. I used my email provider to then forward it to AWS. I&rsquo;m using Amazon to register a domain (click TLD domain names are only $3). I used route53 to hook that domain up to SES, then have SES invoke a Lambda when that particular email address is emailed from a particular email with a particular subject line. As I  can&rsquo;t send the email body directly to a Lambda, I&rsquo;ll need to write it to a bucket first, then have the lambda read from the s3 bucket. (Thankfully SES does pass a MessageID to the Lambda so we know which MessageID refers to to which event), you could also trigger an event from a bucket change but SES already offered, so I figured this was a bit simpler. Now that I&rsquo;ve got it all triggering a Lambda, I can throw code at this problem."><meta name=author content="Shane Dowling"><link rel=canonical href=http://localhost:8080/posts/2024-01-01-kindle-scribe-to-mastodon/><link crossorigin=anonymous href=/assets/css/stylesheet.8fe10233a706bc87f2e08b3cf97b8bd4c0a80f10675a143675d59212121037c0.css integrity="sha256-j+ECM6cGvIfy4Is8+XuL1MCoDxBnWhQ2ddWSEhIQN8A=" rel="preload stylesheet" as=style><link rel=icon href=http://localhost:8080/favicon.ico><link rel=icon type=image/png sizes=16x16 href=http://localhost:8080/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=http://localhost:8080/favicon-32x32.png><link rel=apple-touch-icon href=http://localhost:8080/apple-touch-icon.png><link rel=mask-icon href=http://localhost:8080/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=http://localhost:8080/posts/2024-01-01-kindle-scribe-to-mastodon/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=http://localhost:8080/ accesskey=h title="Shane Dowling (Alt + H)">Shane Dowling</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=http://localhost:8080/posts/ title=Posts><span>Posts</span></a></li><li><a href=http://localhost:8080/categories/ title=Categories><span>Categories</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">Kindle Scribe to Mastodon</h1><div class=post-meta><span title='2024-01-01 16:45:59.35 +0000 UTC'>January 1, 2024</span>&nbsp;·&nbsp;Shane Dowling</div></header><div class=post-content><img src=/eink.jpg height=400px><h1 id=kindle-scribe-to-mastodon>Kindle Scribe to Mastodon<a hidden class=anchor aria-hidden=true href=#kindle-scribe-to-mastodon>#</a></h1><p>Over the holidays, I put together a fun little project to put out status updates on Mastodon. Of course, I used some spare time to make this as overly-engineered as possible.</p><h2 id=stringing-it-all-together>Stringing It All Together<a hidden class=anchor aria-hidden=true href=#stringing-it-all-together>#</a></h2><p>I wanted this to be event-driven and serverless and to give me some experience toying with Terraform in AWS. Thankfully, what would be the most computationally challenging part is already handled by Amazon. The Kindle Scribe provides a means to convert a note to text and then email it to myself. I used my email provider to then forward it to AWS. I&rsquo;m using Amazon to register a domain (click TLD domain names are only $3). I used route53 to hook that domain up to SES, then have SES invoke a Lambda when that particular email address is emailed from a particular email with a particular subject line. As I can&rsquo;t send the email body directly to a Lambda, I&rsquo;ll need to write it to a bucket first, then have the lambda read from the s3 bucket. (Thankfully SES does pass a MessageID to the Lambda so we know which MessageID refers to to which event), you could also trigger an event from a bucket change but SES already offered, so I figured this was a bit simpler. Now that I&rsquo;ve got it all triggering a Lambda, I can throw code at this problem.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;aws_ses_domain_identity&#34; &#34;ses_domain&#34;</span> {
</span></span><span style=display:flex><span>	domain <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;your_domain_name&#34;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;aws_ses_domain_dkim&#34; &#34;ses_dkim&#34;</span> {
</span></span><span style=display:flex><span>	domain <span style=color:#f92672>=</span> <span style=color:#66d9ef>aws_ses_domain_identity</span>.<span style=color:#66d9ef>ses_domain</span>.<span style=color:#66d9ef>id</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>output</span> <span style=color:#e6db74>&#34;ses_domain_verification_token&#34;</span> {
</span></span><span style=display:flex><span>	value <span style=color:#f92672>=</span> <span style=color:#66d9ef>aws_ses_domain_identity</span>.<span style=color:#66d9ef>ses_domain</span>.<span style=color:#66d9ef>verification_token</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>output</span> <span style=color:#e6db74>&#34;dkim_tokens&#34;</span> {
</span></span><span style=display:flex><span>	value <span style=color:#f92672>=</span> <span style=color:#66d9ef>aws_ses_domain_dkim</span>.<span style=color:#66d9ef>ses_dkim</span>.<span style=color:#66d9ef>dkim_tokens</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;aws_ses_receipt_rule_set&#34; &#34;main&#34;</span> {
</span></span><span style=display:flex><span>	rule_set_name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;main-rule-set&#34;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;aws_ses_receipt_rule&#34; &#34;store_in_s3_and_invoke_lambda&#34;</span> {
</span></span><span style=display:flex><span>	name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;store-in-s3-and-invoke-lambda&#34;</span>
</span></span><span style=display:flex><span>		rule_set_name <span style=color:#f92672>=</span> <span style=color:#66d9ef>aws_ses_receipt_rule_set</span>.<span style=color:#66d9ef>main</span>.<span style=color:#66d9ef>rule_set_name</span>
</span></span><span style=display:flex><span>		recipients  <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#34;your_inbound_email@your_domain_name&#34;, &#34;do-not-reply@amazon.com&#34;</span>]
</span></span><span style=display:flex><span>		enabled    <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>		scan_enabled <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>add_header_action</span> {
</span></span><span style=display:flex><span>			position   <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>				header_name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Custom-Header&#34;</span>
</span></span><span style=display:flex><span>				header_value <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Added by SES&#34;</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>s3_action</span> {
</span></span><span style=display:flex><span>		position  <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>			bucket_name <span style=color:#f92672>=</span> <span style=color:#66d9ef>aws_s3_bucket</span>.<span style=color:#66d9ef>email_bucket</span>.<span style=color:#66d9ef>bucket</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>lambda_action</span> {
</span></span><span style=display:flex><span>		position   <span style=color:#f92672>=</span> <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>			function_arn <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;arn:aws:lambda:&lt;region&gt;:&lt;account_id&gt;:function:ProcessEmail&#34;</span>
</span></span><span style=display:flex><span>			invocation_type <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Event&#34;</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	depends_on <span style=color:#f92672>=</span> [<span style=color:#66d9ef>aws_lambda_permission</span>.<span style=color:#66d9ef>allow_ses</span>]
</span></span><span style=display:flex><span>}<span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e># Grant SES permission to invoke the Lambda function
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;aws_lambda_permission&#34; &#34;allow_ses&#34;</span> {
</span></span><span style=display:flex><span>	statement_id <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;AllowExecutionFromSES&#34;</span>
</span></span><span style=display:flex><span>		action    <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;lambda:InvokeFunction&#34;</span>
</span></span><span style=display:flex><span>		principal   <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;ses.amazonaws.com&#34;</span>
</span></span><span style=display:flex><span>		function_name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;${aws_lambda_function.process_email.function_name}&#34;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>output</span> <span style=color:#e6db74>&#34;ses_domain_identity_arn&#34;</span> {
</span></span><span style=display:flex><span>	value <span style=color:#f92672>=</span> <span style=color:#66d9ef>aws_ses_domain_identity</span>.<span style=color:#66d9ef>ses_domain</span>.<span style=color:#66d9ef>arn</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;aws_ses_email_identity&#34; &#34;email_identity&#34;</span> {
</span></span><span style=display:flex><span>	email <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&lt;your_recipient_email&gt;&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;aws_s3_bucket&#34; &#34;email_bucket&#34;</span> {
</span></span><span style=display:flex><span>	bucket <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&lt;your_email_storage_bucket&gt;&#34;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;aws_s3_bucket_policy&#34; &#34;allow_ses_write&#34;</span> {
</span></span><span style=display:flex><span>	bucket <span style=color:#f92672>=</span> <span style=color:#66d9ef>aws_s3_bucket</span>.<span style=color:#66d9ef>email_bucket</span>.<span style=color:#66d9ef>id</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	policy <span style=color:#f92672>=</span> <span style=color:#66d9ef>jsonencode</span>({
</span></span><span style=display:flex><span>		Version <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;2012-10-17&#34;</span>,
</span></span><span style=display:flex><span>		Statement <span style=color:#f92672>=</span>[
</span></span><span style=display:flex><span>			{
</span></span><span style=display:flex><span>				Action  <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;s3:PutObject&#34;</span>,
</span></span><span style=display:flex><span>				Effect  <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Allow&#34;</span>,
</span></span><span style=display:flex><span>				Resource <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;${aws_s3_bucket.email_bucket.arn}/*&#34;</span>,
</span></span><span style=display:flex><span>				Principal <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>					Service <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;ses.amazonaws.com&#34;</span>
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		]
</span></span><span style=display:flex><span>	})
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;aws_iam_role&#34; &#34;lambda_exec_role&#34;</span>{                 
</span></span><span style=display:flex><span>	name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;lambda_exec_role&#34;</span>
</span></span><span style=display:flex><span>		assume_role_policy <span style=color:#f92672>=</span> <span style=color:#66d9ef>jsonencode</span>({  
</span></span><span style=display:flex><span>				Version <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;2012-10-17&#34;</span>,  
</span></span><span style=display:flex><span>				Statement <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>			{                                    
</span></span><span style=display:flex><span>				Action <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;sts:AssumeRole&#34;</span>,                      
</span></span><span style=display:flex><span>				Effect <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Allow&#34;</span>,
</span></span><span style=display:flex><span>				Principal <span style=color:#f92672>=</span> {         
</span></span><span style=display:flex><span>				Service <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;lambda.amazonaws.com&#34;</span>
</span></span><span style=display:flex><span>				},
</span></span><span style=display:flex><span>			},
</span></span><span style=display:flex><span>		],
</span></span><span style=display:flex><span>	})
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;aws_iam_policy&#34; &#34;lambda_policy&#34;</span>{                
</span></span><span style=display:flex><span>	name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;lambda_policy&#34;</span>
</span></span><span style=display:flex><span>		policy <span style=color:#f92672>=</span> <span style=color:#66d9ef>jsonencode</span>({        
</span></span><span style=display:flex><span>				Version <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;2012-10-17&#34;</span>,                          
</span></span><span style=display:flex><span>				Statement <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>			{
</span></span><span style=display:flex><span>				Action <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>					<span style=color:#e6db74>&#34;s3:GetObject&#34;</span>,
</span></span><span style=display:flex><span>					<span style=color:#e6db74>&#34;s3:ListBucket&#34;</span>,
</span></span><span style=display:flex><span>				],
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>				Effect <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Allow&#34;</span>,
</span></span><span style=display:flex><span>				Resource <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>					<span style=color:#e6db74>&#34;${aws_s3_bucket.email_bucket.arn}&#34;</span>,
</span></span><span style=display:flex><span>					<span style=color:#e6db74>&#34;${aws_s3_bucket.email_bucket.arn}/*&#34;</span>,
</span></span><span style=display:flex><span>				],
</span></span><span style=display:flex><span>			},
</span></span><span style=display:flex><span>			{
</span></span><span style=display:flex><span>				Action <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>					<span style=color:#e6db74>&#34;logs:CreateLogGroup&#34;</span>,
</span></span><span style=display:flex><span>					<span style=color:#e6db74>&#34;logs:CreateLogStream&#34;</span>,
</span></span><span style=display:flex><span>					<span style=color:#e6db74>&#34;logs:PutLogEvents&#34;</span>,
</span></span><span style=display:flex><span>				],
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>				Effect <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Allow&#34;</span>,
</span></span><span style=display:flex><span>				Resource <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;arn:aws:logs:*:*:*&#34;</span>,
</span></span><span style=display:flex><span>			},
</span></span><span style=display:flex><span>		],
</span></span><span style=display:flex><span>	})
</span></span><span style=display:flex><span>}<span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e># Attach the policy to the role
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;aws_iam_role_policy_attachment&#34; &#34;lambda_attach&#34;</span>{
</span></span><span style=display:flex><span>	role    <span style=color:#f92672>=</span> <span style=color:#66d9ef>aws_iam_role</span>.<span style=color:#66d9ef>lambda_exec_role</span>.<span style=color:#66d9ef>name</span>
</span></span><span style=display:flex><span>		policy_arn <span style=color:#f92672>=</span> <span style=color:#66d9ef>aws_iam_policy</span>.<span style=color:#66d9ef>lambda_policy</span>.<span style=color:#66d9ef>arn</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;aws_lambda_function&#34; &#34;process_email&#34;</span>{
</span></span><span style=display:flex><span>	function_name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;ProcessEmail&#34;</span>
</span></span><span style=display:flex><span>		handler    <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;lambda_function.lambda_handler&#34;</span>
</span></span><span style=display:flex><span>		runtime    <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;python3.10&#34;</span>
</span></span><span style=display:flex><span>		role     <span style=color:#f92672>=</span> <span style=color:#66d9ef>aws_iam_role</span>.<span style=color:#66d9ef>lambda_exec_role</span>.<span style=color:#66d9ef>arn</span>
</span></span><span style=display:flex><span>		filename     <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;${path.module}/build/lambda_function.zip&#34;</span>
</span></span><span style=display:flex><span>		source_code_hash <span style=color:#f92672>=</span> <span style=color:#66d9ef>filebase64sha256</span>(<span style=color:#e6db74>&#34;${path.module}/build/lambda_function.zip&#34;</span>)
</span></span><span style=display:flex><span>		timeout    <span style=color:#f92672>=</span> <span style=color:#ae81ff>60</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=parsing-the-email>Parsing the Email<a hidden class=anchor aria-hidden=true href=#parsing-the-email>#</a></h2><p>It&rsquo;s slightly complicated as Amazon doesn&rsquo;t attach the content directly to the email; they provide a link to grab the text document. Thankfully, it doesn&rsquo;t require authentication, so with a regex, we can grab the URL and extract the text. The file itself is text split into pages. As my use-case is to flip to a new page, write a status, and post it to the web, I always just need to extract the latest page text.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> boto3
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> email
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> urllib
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> re
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Initialize S3 client</span>
</span></span><span style=display:flex><span>s3 <span style=color:#f92672>=</span> boto3<span style=color:#f92672>.</span>client(<span style=color:#e6db74>&#39;s3&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Extract the message ID from the SES event                </span>
</span></span><span style=display:flex><span>message_id <span style=color:#f92672>=</span> event[<span style=color:#e6db74>&#39;Records&#39;</span>][<span style=color:#ae81ff>0</span>][<span style=color:#e6db74>&#39;ses&#39;</span>][<span style=color:#e6db74>&#39;mail&#39;</span>][<span style=color:#e6db74>&#39;messageId&#39;</span>]       
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Define the S3 bucket name and object key</span>
</span></span><span style=display:flex><span>bucket_name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;&lt;your_bucket_name&gt;&#39;</span>
</span></span><span style=display:flex><span>object_key <span style=color:#f92672>=</span> message_id
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Get the email object from the S3 bucket</span>
</span></span><span style=display:flex><span>email_object <span style=color:#f92672>=</span> s3<span style=color:#f92672>.</span>get_object(Bucket<span style=color:#f92672>=</span>bucket_name, Key<span style=color:#f92672>=</span>object_key)
</span></span><span style=display:flex><span>email_content <span style=color:#f92672>=</span> email_object[<span style=color:#e6db74>&#39;Body&#39;</span>]<span style=color:#f92672>.</span>read()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Parse the email content</span>
</span></span><span style=display:flex><span>parsed_email <span style=color:#f92672>=</span> email<span style=color:#f92672>.</span>message_from_bytes(email_content)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Assuming the email is multipart</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> parsed_email<span style=color:#f92672>.</span>is_multipart():
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> part <span style=color:#f92672>in</span> parsed_email<span style=color:#f92672>.</span>walk():
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Find the HTML part of the email</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> part<span style=color:#f92672>.</span>get_content_type() <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;text/html&#39;</span>:
</span></span><span style=display:flex><span>	html_content <span style=color:#f92672>=</span> part<span style=color:#f92672>.</span>get_payload(decode<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>)<span style=color:#f92672>.</span>decode(<span style=color:#e6db74>&#39;utf-8&#39;</span>)
</span></span><span style=display:flex><span>	<span style=color:#75715e># Extract the URL using regex</span>
</span></span><span style=display:flex><span>	url_pattern <span style=color:#f92672>=</span> <span style=color:#e6db74>r</span><span style=color:#e6db74>&#39;https://www\.amazon\.com/gp/f\.html\?[^&#34;]+&#39;</span>
</span></span><span style=display:flex><span>	url_match <span style=color:#f92672>=</span> re<span style=color:#f92672>.</span>search(url_pattern, html_content)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> url_match:
</span></span><span style=display:flex><span>		file_url <span style=color:#f92672>=</span> url_match<span style=color:#f92672>.</span>group(<span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>		<span style=color:#75715e># Download the file content using urllib</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>with</span> urllib<span style=color:#f92672>.</span>request<span style=color:#f92672>.</span>urlopen(file_url, timeout<span style=color:#f92672>=</span><span style=color:#ae81ff>20</span>) <span style=color:#66d9ef>as</span> response:
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>if</span> response<span style=color:#f92672>.</span>status <span style=color:#f92672>==</span> <span style=color:#ae81ff>200</span>:
</span></span><span style=display:flex><span>					file_content <span style=color:#f92672>=</span> response<span style=color:#f92672>.</span>read()<span style=color:#f92672>.</span>decode(<span style=color:#e6db74>&#39;utf-8&#39;</span>)
</span></span><span style=display:flex><span>					pages <span style=color:#f92672>=</span> re<span style=color:#f92672>.</span>split(<span style=color:#e6db74>r</span><span style=color:#e6db74>&#39;Page \d+&#39;</span>, file_content)
</span></span><span style=display:flex><span>					last_page_content <span style=color:#f92672>=</span> pages[<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>]<span style=color:#f92672>.</span>strip() <span style=color:#75715e># Get the last page content and strip leading/trailing whitespace</span>
</span></span><span style=display:flex><span>					print(<span style=color:#e6db74>&#34;Content to be published:</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, last_page_content)
</span></span><span style=display:flex><span>					<span style=color:#75715e># send_blog_post(last_pagecontent) # Uncomment and replace with your function</span>
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>					print(<span style=color:#e6db74>&#34;Failed to download the file. Status code:&#34;</span>, response<span style=color:#f92672>.</span>status)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>except</span> <span style=color:#a6e22e>Exception</span> <span style=color:#66d9ef>as</span> e:
</span></span><span style=display:flex><span>				print(<span style=color:#e6db74>&#34;Error downloading the file:&#34;</span>, e)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>			print(<span style=color:#e6db74>&#34;URL not found in the email content.&#34;</span>)
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>			print(<span style=color:#e6db74>&#34;Email is not multipart, unable to parse.&#34;</span>)
</span></span></code></pre></div><h2 id=posting-the-status>Posting the Status<a hidden class=anchor aria-hidden=true href=#posting-the-status>#</a></h2><p>Now that we&rsquo;ve got the text, it&rsquo;s time to post it online. As I&rsquo;m using omg.lol, I will post it to my status.lol site, which will also submit it to my social.lol Mastodon account. Obviously, we can plug in any service that provides API access.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> re
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> json
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> urllib
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>send_post</span>(content):
</span></span><span style=display:flex><span>    address_name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&lt;your_omg.lol_name&gt;&#34;</span>
</span></span><span style=display:flex><span>    api_key <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&lt;your_secret&gt;&#34;</span>  <span style=color:#75715e># Extract from secret manager or parameter store</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    data <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#34;status&#34;</span>: content, <span style=color:#e6db74>&#34;external_url&#34;</span>: <span style=color:#e6db74>&#34;https://example.com&#34;</span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>encoded_data <span style=color:#f92672>=</span> json<span style=color:#f92672>.</span>dumps(data)<span style=color:#f92672>.</span>encode(<span style=color:#e6db74>&#34;utf-8&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#75715e># Prepare the request</span>
</span></span><span style=display:flex><span>url <span style=color:#f92672>=</span> <span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;https://api.omg.lol/address/</span><span style=color:#e6db74>{</span>address_name<span style=color:#e6db74>}</span><span style=color:#e6db74>/statuses/&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>headers <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#34;Authorization&#34;</span>: <span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;Bearer </span><span style=color:#e6db74>{</span>api_key<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>, <span style=color:#e6db74>&#34;Content-Type&#34;</span>: <span style=color:#e6db74>&#34;application/json&#34;</span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>req <span style=color:#f92672>=</span> urllib<span style=color:#f92672>.</span>request<span style=color:#f92672>.</span>Request(url, data<span style=color:#f92672>=</span>encoded_data, headers<span style=color:#f92672>=</span>headers, method<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;POST&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#75715e># Send the request</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>with</span> urllib<span style=color:#f92672>.</span>request<span style=color:#f92672>.</span>urlopen(req) <span style=color:#66d9ef>as</span> response:
</span></span><span style=display:flex><span>        response_body <span style=color:#f92672>=</span> response<span style=color:#f92672>.</span>read()<span style=color:#f92672>.</span>decode(<span style=color:#e6db74>&#34;utf-8&#34;</span>)
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#34;Response from server:&#34;</span>, response_body)
</span></span><span style=display:flex><span><span style=color:#66d9ef>except</span> urllib<span style=color:#f92672>.</span>error<span style=color:#f92672>.</span>URLError <span style=color:#66d9ef>as</span> e:
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>&#34;Error sending request:&#34;</span>, e<span style=color:#f92672>.</span>reason)
</span></span></code></pre></div><h2 id=quick-tip>Quick Tip<a hidden class=anchor aria-hidden=true href=#quick-tip>#</a></h2><p>If you&rsquo;re not confident Amazon will parse all your text correctly, you can always preview the conversion to text before emailing it. Just hit &lsquo;Convert to Text and Email&rsquo;, rather than &lsquo;Quick Send&rsquo; it.</p><p>And that was a fun project that&rsquo;s started to motivate me to write more on my Kindle. In fact, I initially wrote this entire blog post on my Kindle. Thanks for reading!</p></div><footer class=post-footer><ul class=post-tags></ul></footer></article></main><footer class=footer><span>&copy; 2025 <a href=http://localhost:8080/>Shane Dowling</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>