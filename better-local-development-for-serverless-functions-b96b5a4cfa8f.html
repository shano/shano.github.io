<!DOCTYPE html>
<html lang="en">
<head>
        <title>Shane Dowling : Better local development for Serverless Functions</title>
        <meta charset="utf-8" />
        <link rel="stylesheet" href="./theme/css/main.css" type="text/css" />
        <link href="https://shanedowling.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Shane Dowling ATOM Feed" />

        <!--[if IE]>
                <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

        <!--[if lte IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="./css/ie.css"/>
                <script src="./js/IE8.js" type="text/javascript"></script><![endif]-->

        <!--[if lt IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="./css/ie6.css"/><![endif]-->

</head>

<body>
        
<header>
    <h1><a href="." id="site-title">Shane Dowling </a> :
        <a href="./better-local-development-for-serverless-functions-b96b5a4cfa8f.html" id="page-title">Better local development for Serverless Functions</a></h1>
<time datetime="2019-02-11T20:15:38.791000+00:00">Mon 11 February 2019</time></header>
<article>
    <p><img alt="" src="images/1__roedigbmFjRYkZobdZWuKg.jpeg"></p>
<p>Lambda is a terrific piece of kit for all the benefits listed on the <a href="https://aws.amazon.com/lambda/">AWS product page</a> and <a href="https://serverless.com/">Serverless</a> is a very useful framework for developing Lambda functions. However, developing serverless applications locally is a total pain if what you're solving isn't totally trivial.</p>
<p>When things get complicated and your Lambda functions start to integrate with other AWS services, things really begin to break down. There are a few things that look like silver-bullets, I'll share them here and explain why they didn't work for me, then give you a working example that I myself struggled to find(hence me writing this).</p>
<h3>Localstack</h3>
<p><a href="https://github.com/localstack/localstack">Localstack</a> is definitely the biggest attempt at a silver bullet here. Basically it emulates a huge chunk of AWS locally and you connect your serverless functions into that. Why I didn't use it:</p>
<ol>
<li>Bits worked, but if you have any sort of half complicated setup(like a region outside us-east-1 or eu-west-1), it will break down. Uploading a whole cloudformation template was a disaster of broken links between services. I got to the point of editing localstack code to try fix issue after issue I was coming across and gave up. The product would be cool if it wasn't trying to do something so super complicated.</li>
<li>It's also a huge resource drain on a developer's machine.</li>
<li>Fundamentally, you shouldn't have to emulate half of AWS to test your code.</li>
</ol>
<h3>Serverless Offline</h3>
<p>Serverless offline is fairly straightforward. It should allow you to spin up your functions locally and call them as needed. Where this fell down for me was that it required you to have HTTP endpoints for your lambda functions, all of our Lambda functions were driven either by SQS events or a Cron. We also instantiate our SNS topics in our code, so it would constantly attempt to create SNS topics and AWS would throw errors.</p>
<p>I also did try using <a href="https://www.npmjs.com/package/serverless-offline-sqs">serverless-offline-sqs</a> but could not get it to drive events into our Lamdba functions.</p>
<p>I was burning a lot of time getting a dev environment setup and I realised that this was fundamentally the wrong approach. I needed to start writing proper unit tests and use mocking to emulate the infrastructure(I mean ideally they'd be isolated properly and infrastructure/functions would be totally ignorant of each other, but that's for another day).</p>
<h3>The Example</h3>
<p>Say we're developing an application that makes use of:</p>
<ul>
<li>Lambda</li>
<li>MongoDB</li>
<li>SQS</li>
<li>SNS</li>
</ul>
<p>Your lambda function connects to your MongoDB, does a thing and fires off occasional SNS notifications/SQS messages to other services.</p>
<p><strong>Lambda</strong></p>
<p>For the actual code being run, I was going to use <a href="https://www.npmjs.com/package/jest">jest</a> to start writing tests. Jest works well and integrates nicely into serverless.</p>
<p><strong>MongoDB</strong></p>
<p>To emulate MongoDB, I'm going to use an <a href="https://www.npmjs.com/package/mongodb-memory-server">in-memory version of MongoDB</a> that ties nicely into our Mongoose models.</p>
<p><strong>SQS/SNS</strong></p>
<p>For any Amazon infrastructure, we're going to use <a href="https://www.npmjs.com/package/aws-sdk-mock">aws-sdk-mock</a>. This is an excellent wrapper around <a href="https://www.npmjs.com/package/sinon">sinon</a> for mocking the AWS infrastructure, that's super useful for unit tests as you'll see later.</p>
<h3>Tieing it all together</h3>
<p>So firstly lets install our dependencies.</p>
<p><code>npm install aws-sdk-mock mongodb-memory-server sinon jest --save-dev</code></p>
<p>Let's also create a tests folder to keep all this test code in.</p>
<p>mkdir tests</p>
<p><strong>Setting up MongoDB</strong></p>
<p>Now, for our code to integrate with our in-memory Mongo-DB server, we're going to need to add a few setup/teardown functions and a Mongo Environment. Clone this <a href="https://github.com/vladgolubev/jest-mongodb">repo</a> and put:</p>
<ul>
<li><code>setup.js</code></li>
<li><code>teardown.js</code></li>
<li><code>mongo-environment.js</code></li>
</ul>
<p>into your new test folder.</p>
<p>In your root directory add a <code>jest.config.js</code> with this content.</p>
<div class="highlight"><pre><span></span><code><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">globalSetup</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;./tests/setup.js&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="nx">globalTeardown</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;./tests/teardown.js&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="nx">testEnvironment</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;./tests/mongo-environment.js&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="nx">roots</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;./tests/&#39;</span><span class="p">],</span>
<span class="p">};</span>
</code></pre></div>

<p>This should be enough to get MongoDB up and running. Now onto our actual tests scripts.</p>
<p><strong>Setting up our tests</strong></p>
<p>Now, finally, you can tie it all together with this snippet:</p>
<p>Add jest to your package.json</p>
<div class="highlight"><pre><span></span><code><span class="nt">&quot;scripts&quot;</span><span class="p">:{</span>
<span class="w">  </span><span class="nt">&quot;test&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;jest&quot;</span>
<span class="p">},</span>
</code></pre></div>

<p>And run with <code>npm test</code>.</p>
<p>One major point to note is that aws-mock-sdk requires a very specific way of instantiating AWS resources(within the scope of the function tests), so if you see any errors around aws regions, double check <a href="https://github.com/dwyl/aws-sdk-mock#use-in-your-tests">you're following the rules</a>.</p>
</article>

        <footer>
            <nav>
                <ul>
                    <li><a href="./pages/contact.html">Contact</a></li>
                    <li>:: <a href="./categories.html">Categories</a></li>
                </ul>
            </nav>
                <p id="theme-credit"><a href="http://mathieu.agopian.info/mnmlist/theme.html">Th√®me mnmlist</a></p>
        </footer>

</body>
</html>