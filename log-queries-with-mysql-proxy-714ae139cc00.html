<!DOCTYPE html>
<html lang="en">
<head>
        <title>Log Queries with MySQL Proxy</title>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/pure-min.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/grids-responsive-min.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.4.0/css/font-awesome.min.css" />
        <link rel="stylesheet" href="./theme/css/main.css" />
        <link href="https://shanedowling.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Shane Dowling Full Atom Feed" />
        <link href="https://shanedowling.com/feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="Shane Dowling Full RSS Feed" />
        <link href="https://shanedowling.com/feeds/category.slug.atom.xml" type="application/atom+xml" rel="alternate" title="Shane Dowling Categories Atom Feed" />
        <link href="https://shanedowling.com/feeds/category.slug.rss.xml" type="application/rss+xml" rel="alternate" title="Shane Dowling Categories RSS Feed" />
</head>
<body>

    <div class="main-nav-container">

        <div class="pure-g">
            <div class="pure-u-1 pure-u-lg-2-3">
                <div class="main-nav">
                    <ul class="main-nav-list">
                        <li class="main-nav-item"><a href="./" class="pure-menu-link">Shane Dowling</a></li>

                        <li class="main-nav-item active"><a href="./category/posts.html" class="pure-menu-link">posts</a></li>
                    </ul>
                </div>
             </div>

             <div class="pure-u-1 pure-u-lg-1-3"></div>
        </div>

    </div>


<div class="page-container">
    <div class="entry-content">
        <div class="post-meta pure-g">
            <div class="pure-u-3-4 meta-data">
                <a href="./category/posts.html" class="category">posts</a><br />

                <a class="author" href="./author/shane-dowling.html">Shane Dowling</a>
                &mdash; <abbr title="2014-07-19T00:00:00+00:00">Sat 19 July 2014</abbr>
            </div>
        </div>
    </div>

    <div class="article-header-container">
        <div class="background-image-container">

            <div class="background-image-small">
                <div class="title-container">
                    <h1>Log Queries with MySQL Proxy</h1>
                </div>
            </div>
        </div>
    </div>

    <div class="entry-content">
        <p><img alt="" src="images/1__HJJkQeHYeEx3PtDHrtR6pQ.png"></p>
<h3>What is it?</h3>
<p>Have you ever found yourself wanting live statistics of you mysql
database, or a log of all the erroring queries. Well MySQL Proxy might</p>
<p>MySQL Proxy is a simple program that sits between your client and MySQL server(s) that can monitor, analyze or transform their communication.</p>
<p>Basically MySQL Proxy collects database queries and acts on them using
scripts built in lua that can do some useful things. I find this handy
when debugging SugarCRM as sometimes failed database queries get
suppressed(especially when making API requests) and I needed a
transparent way to check nothing has failed on the DB side.</p>
<h3>Installation</h3>
<p>This example I’m going to show you allows you to sit the proxy on
3306(instead of mysql), so you don’t need to alter any of the code point
to your existing MySQL installation. If this isn’t what you want change
your steps accordingly.</p>
<p>- Basically in your my.cnf. Change your servers port to 3307(server
 only not the client). Then restart mysql.
- Now install mysql-proxy using your regular package manager(it should
 even work on homebrew).</p>
<p>mysql-proxy proxy-backend-addresses=127.0.0.1:3307 log-level=debug proxy-address=127.0.0.1:3306 proxy-lua-script=/usr/local/Cellar/mysql-proxy/0.8.3/lib/mysql-proxy/lua/proxy/mysql-proxy-log-error-queries.lua plugins=proxy</p>
<p>If that default example lua script doesn’t exist, simply copy one of the
files below and point proxy-lua-script to that.</p>
<h3>Log any bad queries the database has to handle.</h3>
<p>local errflag = false
 function readquery( packet )
 if packet:byte() == proxy.COMQUERY then
 local user = proxy.connection.client.username
 local host = proxy.connection.client.src.name
 print(user .. ‘@’ .. host)
 if [[true or]] user:lower() == ‘root’ then
 [[
 host will always be localhost because of proxy
 and not ( host:lower() == ‘localhost’
 or host:lower() == ‘127.0.0.1’ ) then
 ]]
 proxy.queries:append(1, packet, {resultsetisneeded = true})
 proxy.queries:append(2, string.char(proxy.COMQUERY) .. “SET @lastquery = ‘“ .. string.sub(packet, 2) .. “‘“, {resultsetisneeded = true} )
 proxy.queries:append(3, string.char(proxy.COMQUERY) .. “SHOW WARNINGS”, {resultsetisneeded = true} )
 end
 return proxy.PROXYSENDQUERY
 end
 end</p>
<p>function insertquery(errt, errn, errm)
 local query = “INSERT INTO `somedb`.`mysqlerror` “ ..
 “(`date`, `errnum`,`errtype`, `errmessage`, `problemquery`, `connid`)” ..
 “ VALUES ( NOW(), “ ..
 errn .. “,” .. “”” ..
 errt ..””” .. “,” .. “”” ..
 errm .. “”” .. “,” ..
 “@lastquery” .. “,” ..
 proxy.connection.server.threadid .. “)”
 print(query)
 proxy.queries:append(4, string.char(proxy.COMQUERY) .. query, {resultsetisneeded = true})
 return proxy.PROXYSENDQUERY
 end</p>
<p>function readqueryresult(inj)
 local res = assert(inj.resultset)
 if inj.id == 1 then
 errflag = false
 if res.querystatus == proxy.MYSQLDPACKETERR then
 errflag = true
 return proxy.PROXYIGNORERESULT
 end
 elseif inj.id == 2 then
 return proxy.PROXYIGNORERESULT
 elseif inj.id == 3 then
 if errflag == true then
 for row in res.rows do
 proxy.response.type = proxy.MYSQLDPACKETERR
 proxy.response.errmsg = row[3]
 insertquery(row[1], row[2], row[3])
 end
 return proxy.PROXYSENDRESULT
 end
 return proxy.PROXYIGNORERESULT
 elseif inj.id == 4 then
 return proxy.PROXYIGNORERESULT
 end
 end</p>
<h3>Log all queries with stats/warnings</h3>
<p>Found <a href="https://github.com/patrickallaert/MySQL-Proxy-scripts-for-devs/blob/master/debug.lua">here</a>. Useful for spotting those slow/inefficient queries.</p>
    </div>

    <footer>
        <div class="pure-g post-footer">
            <div class="pure-u-1 pure-u-md-1-2">
                <div class="pure-g poster-info">
                    <div class="pure-u-3-4">
                        <h3 class="author-name"><a href="./author/shane-dowling.html">Shane Dowling</a></h3>
                        <p class="author-description">
                        </p>
                    </div>
                </div>
            </div>



        </div>


    </footer>


</div>


</body>
</html>