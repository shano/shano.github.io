<!DOCTYPE html>
<html lang="en">
<head>
        <title>Shane Dowling : Populate Ansible from Amazon secrets manager</title>
        <meta charset="utf-8" />
        <link rel="stylesheet" href="./theme/css/main.css" type="text/css" />
        <link href="https://shanedowling.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Shane Dowling ATOM Feed" />

        <!--[if IE]>
                <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

        <!--[if lte IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="./css/ie.css"/>
                <script src="./js/IE8.js" type="text/javascript"></script><![endif]-->

        <!--[if lt IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="./css/ie6.css"/><![endif]-->

</head>

<body>
        
<header>
    <h1><a href="." id="site-title">Shane Dowling </a> :
        <a href="./populate-ansible-from-amazon-secrets-manager-8eac77127e37.html" id="page-title">Populate Ansible from Amazon secrets manager</a></h1>
<time datetime="2020-09-03T18:06:58.955000+00:00">Thu 03 September 2020</time></header>
<article>
    <p><img alt="" src="images/1__l0WrN40X7lf7tKsbdtj7Sw.png"></p>
<p>One of the ways to improve your security and avoid passing around env files is to follow the <a href="https://12factor.net/config">twelve factor app</a> and start populating your secrets from the environment. Another improvement is to pull those secrets from a known secret store, with features like rotation, auditing etc.</p>
<h3><strong>Requirements</strong></h3>
<ul>
<li><a href="https://www.ansible.com/">Ansible</a></li>
<li>Have some secrets stored in <a href="https://aws.amazon.com/secrets-manager/">AWS Secrets Manager</a></li>
<li>Ansible should have access to the latest <a href="https://aws.amazon.com/cli/">aws-cli</a> command(secrets manager is a recent addition)</li>
<li><a href="https://stedolan.github.io/jq/">Jq</a> if you're storing json in your secrets</li>
</ul>
<p>It's worth testing your AWS calls to just extract the secret you're interested in to stdout, from the terminal tests some calls like:</p>
<div class="highlight"><pre><span></span><code>aws<span class="w"> </span>secretsmanager<span class="w"> </span>get-secret-value<span class="w"> </span>--secret-id<span class="w"> </span>some/secret/name<span class="w"> </span>--query<span class="w"> </span>SecretString<span class="w"> </span>--output<span class="w"> </span>text
</code></pre></div>

<p>Or for json you might do something like:</p>
<div class="highlight"><pre><span></span><code>aws<span class="w"> </span>secretsmanager<span class="w"> </span>get-secret-value<span class="w"> </span>--secret-id<span class="w"> </span>secrets<span class="p">|</span><span class="w"> </span>jq<span class="w"> </span>--raw-output<span class="w"> </span><span class="s1">&#39;.SecretString&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>jq<span class="w"> </span>-r<span class="w"> </span>.API_KEY
</code></pre></div>

<h3>Ansible Config</h3>
<p>Once you have secrets manager outputting your secrets to stdout, you can utilise it in Ansible. In this example I'm outputting to an env file but this could but used anywhere in Ansible. Instead of outputting to a file you could set its own environment variables then spin up the project from Ansible without outputting to a file anywhere.</p>
<div class="highlight"><pre><span></span><code><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Setting env with some secret</span>
<span class="w">  </span><span class="nt">args</span><span class="p">:</span>
<span class="w">    </span><span class="nt">executable</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/bin/bash</span>
<span class="w">  </span><span class="nt">shell</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">    </span><span class="no">aws secretsmanager get-secret-value --secret-id some/secret/name --query SecretString --output text</span>
<span class="w">  </span><span class="nt">register</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">some_secret</span>

<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pass response of ssm to .env file</span>
<span class="w">  </span><span class="nt">become</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">no</span>
<span class="w">  </span><span class="nt">blockinfile</span><span class="p">:</span>
<span class="w">    </span><span class="nt">dest</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;{{</span><span class="nv"> </span><span class="s">some_environment_path</span><span class="nv"> </span><span class="s">}}/.env&#39;</span>
<span class="w">    </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">present</span>
<span class="w">    </span><span class="nt">create</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">yes</span>
<span class="w">    </span><span class="nt">marker</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;#</span><span class="nv"> </span><span class="s">{mark}</span><span class="nv"> </span><span class="s">MY</span><span class="nv"> </span><span class="s">SECRET</span><span class="nv"> </span><span class="s">FROM</span><span class="nv"> </span><span class="s">AWS</span><span class="nv"> </span><span class="s">#&quot;</span>
<span class="w">    </span><span class="nt">block</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">      </span><span class="no">SOME_SECRET=&#39;{{ some_secret.stdout }}&#39;</span>
</code></pre></div>

<p>And that's it! Anything I could've done better(which I'm sure there is), do let me know!</p>
</article>

        <footer>
            <nav>
                <ul>
                    <li><a href="./pages/contact.html">Contact</a></li>
                    <li>:: <a href="./categories.html">Categories</a></li>
                </ul>
            </nav>
        </footer>

    <script type="text/javascript">
    var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
    document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    </script>
    <script type="text/javascript">
    try {
        var pageTracker = _gat._getTracker("UA-9958527-3");
    pageTracker._trackPageview();
    } catch(err) {}</script>
</body>
</html>