<!DOCTYPE html>
<html lang="en">
<head>
        <title>Populate Ansible from Amazon secrets manager</title>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/pure-min.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/grids-responsive-min.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.4.0/css/font-awesome.min.css" />
        <link rel="stylesheet" href="./theme/css/main.css" />
        <link rel="stylesheet" href="./theme/css/forms.css" />
        <link href="https://shanedowling.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Shane Dowling Full Atom Feed" />
        <link href="https://shanedowling.com/feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="Shane Dowling Full RSS Feed" />
        <link href="https://shanedowling.com/feeds/category.slug.atom.xml" type="application/atom+xml" rel="alternate" title="Shane Dowling Categories Atom Feed" />
        <link href="https://shanedowling.com/feeds/category.slug.rss.xml" type="application/rss+xml" rel="alternate" title="Shane Dowling Categories RSS Feed" />
</head>
<body>

    <div class="main-nav-container">

        <div class="pure-g">
            <div class="pure-u-1 pure-u-lg-2-3">
                <div class="main-nav">
                    <ul class="main-nav-list">
                        <li class="main-nav-item"><a href="./" class="pure-menu-link">Shane Dowling</a></li>

                        <li class="main-nav-item"><a href="./category/til.html" class="pure-menu-link">TIL</a></li>
                        <li class="main-nav-item active"><a href="./category/tech.html" class="pure-menu-link">Tech</a></li>
                        <li class="main-nav-item"><a href="./category/random.html" class="pure-menu-link">Random</a></li>
                        <li class="main-nav-item"><a href="./category/productivity.html" class="pure-menu-link">Productivity</a></li>
                        <li class="main-nav-item"><a href="./category/mindfulness.html" class="pure-menu-link">Mindfulness</a></li>
                        <li class="main-nav-item"><a href="./category/leadership.html" class="pure-menu-link">Leadership</a></li>
                        <li class="main-nav-item"><a href="./category/digital-minimalism.html" class="pure-menu-link">Digital Minimalism</a></li>
                        <li class="main-nav-item"><a href="./pages/contact.html" class="pure-menu-link">Contact</a></li>
                    </ul>
                </div>
             </div>

             <div class="pure-u-1 pure-u-lg-1-3"></div>
        </div>

    </div>


<div class="page-container">
    <div class="entry-content">
        <div class="post-meta pure-g">
            <div class="pure-u-3-4 meta-data">
                <a href="./category/tech.html" class="category">Tech</a><br />

                <a class="author" href="./author/shane-dowling.html">Shane Dowling</a>
                &mdash; <abbr title="2020-09-03T18:06:58.955000+00:00">Thu 03 September 2020</abbr>
            </div>
        </div>
    </div>

    <div class="article-header-container">
        <div class="background-image-container">

            <div class="background-image-small">
                <div class="title-container">
                    <h1>Populate Ansible from Amazon secrets manager</h1>
                </div>
            </div>
        </div>
    </div>

    <div class="entry-content">
        <p><img alt="" src="images/1__l0WrN40X7lf7tKsbdtj7Sw.png"></p>
<p>One of the ways to improve your security and avoid passing around env files is to follow the <a href="https://12factor.net/config">twelve factor app</a> and start populating your secrets from the environment. Another improvement is to pull those secrets from a known secret store, with features like rotation, auditing etc.</p>
<h3><strong>Requirements</strong></h3>
<ul>
<li><a href="https://www.ansible.com/">Ansible</a></li>
<li>Have some secrets stored in <a href="https://aws.amazon.com/secrets-manager/">AWS Secrets Manager</a></li>
<li>Ansible should have access to the latest <a href="https://aws.amazon.com/cli/">aws-cli</a> command(secrets manager is a recent addition)</li>
<li><a href="https://stedolan.github.io/jq/">Jq</a> if you're storing json in your secrets</li>
</ul>
<p>It's worth testing your AWS calls to just extract the secret you're interested in to stdout, from the terminal tests some calls like:</p>
<div class="highlight"><pre><span></span>aws secretsmanager get-secret-value --secret-id some/secret/name --query SecretString --output text
</pre></div>


<p>Or for json you might do something like:</p>
<div class="highlight"><pre><span></span>aws secretsmanager get-secret-value --secret-id secrets<span class="p">|</span> jq --raw-output <span class="s1">&#39;.SecretString&#39;</span> <span class="p">|</span> jq -r .API_KEY
</pre></div>


<h3>Ansible Config</h3>
<p>Once you have secrets manager outputting your secrets to stdout, you can utilise it in Ansible. In this example I'm outputting to an env file but this could but used anywhere in Ansible. Instead of outputting to a file you could set its own environment variables then spin up the project from Ansible without outputting to a file anywhere.</p>
<div class="highlight"><pre><span></span><span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Setting env with some secret</span>
  <span class="nt">args</span><span class="p">:</span>
    <span class="nt">executable</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/bin/bash</span>
  <span class="nt">shell</span><span class="p">:</span> <span class="p p-Indicator">|</span>
    <span class="no">aws secretsmanager get-secret-value --secret-id some/secret/name --query SecretString --output text</span>
  <span class="nt">register</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">some_secret</span>

<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">pass response of ssm to .env file</span>
  <span class="nt">become</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">no</span>
  <span class="nt">blockinfile</span><span class="p">:</span>
    <span class="nt">dest</span><span class="p">:</span> <span class="s">&#39;{{</span><span class="nv"> </span><span class="s">some_environment_path</span><span class="nv"> </span><span class="s">}}/.env&#39;</span>
    <span class="nt">state</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">present</span>
    <span class="nt">create</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>
    <span class="nt">marker</span><span class="p">:</span> <span class="s">&quot;#</span><span class="nv"> </span><span class="s">{mark}</span><span class="nv"> </span><span class="s">MY</span><span class="nv"> </span><span class="s">SECRET</span><span class="nv"> </span><span class="s">FROM</span><span class="nv"> </span><span class="s">AWS</span><span class="nv"> </span><span class="s">#&quot;</span>
    <span class="nt">block</span><span class="p">:</span> <span class="p p-Indicator">|</span>
      <span class="no">SOME_SECRET=&#39;{{ some_secret.stdout }}&#39;</span>
</pre></div>


<p>And that's it! Anything I could've done better(which I'm sure there is), do let me know!</p>
    </div>

    <footer>
        <div class="pure-g post-footer">
            <div class="pure-u-1 pure-u-md-1-2">
                <div class="pure-g poster-info">
                    <div class="pure-u-3-4">
                        <h3 class="author-name"><a href="./author/shane-dowling.html">Shane Dowling</a></h3>
                        <p class="author-description">
                        </p>
                    </div>
                </div>
            </div>



        </div>


    </footer>


</div>


    <!-- Matomo -->
        <script>
          var _paq = window._paq = window._paq || [];
          /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
          _paq.push(['trackPageView']);
          _paq.push(['enableLinkTracking']);
          (function() {
            var u="//stats.shanedowling.com/";
            _paq.push(['setTrackerUrl', u+'matomo.php']);
                  _paq.push(['setSiteId', '1']);
            var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
            g.async=true; g.src=u+'matomo.js'; s.parentNode.insertBefore(g,s);
          })();
        </script>
        <!-- End Matomo Code -->
</body>
</html>