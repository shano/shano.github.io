<!DOCTYPE html>
<html lang="en">
<head>
        <title>SugarCRM — Prevent currencies getting overridden</title>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/pure-min.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/grids-responsive-min.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.4.0/css/font-awesome.min.css" />
        <link rel="stylesheet" href="./theme/css/main.css" />
        <link rel="stylesheet" href="./theme/css/forms.css" />
        <link href="https://shanedowling.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Shane Dowling Full Atom Feed" />
        <link href="https://shanedowling.com/feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="Shane Dowling Full RSS Feed" />
        <link href="https://shanedowling.com/feeds/category.slug.atom.xml" type="application/atom+xml" rel="alternate" title="Shane Dowling Categories Atom Feed" />
        <link href="https://shanedowling.com/feeds/category.slug.rss.xml" type="application/rss+xml" rel="alternate" title="Shane Dowling Categories RSS Feed" />
</head>
<body>

    <div class="main-nav-container">

        <div class="pure-g">
            <div class="pure-u-1 pure-u-lg-2-3">
                <div class="main-nav">
                    <ul class="main-nav-list">
                        <li class="main-nav-item"><a href="./" class="pure-menu-link">Shane Dowling</a></li>

                        <li class="main-nav-item"><a href="./category/til.html" class="pure-menu-link">TIL</a></li>
                        <li class="main-nav-item active"><a href="./category/tech.html" class="pure-menu-link">Tech</a></li>
                        <li class="main-nav-item"><a href="./category/random.html" class="pure-menu-link">Random</a></li>
                        <li class="main-nav-item"><a href="./category/productivity.html" class="pure-menu-link">Productivity</a></li>
                        <li class="main-nav-item"><a href="./category/mindfulness.html" class="pure-menu-link">Mindfulness</a></li>
                        <li class="main-nav-item"><a href="./category/leadership.html" class="pure-menu-link">Leadership</a></li>
                        <li class="main-nav-item"><a href="./category/digital-minimalism.html" class="pure-menu-link">Digital Minimalism</a></li>
                        <li class="main-nav-item"><a href="./pages/contact.html" class="pure-menu-link">Contact</a></li>
                    </ul>
                </div>
             </div>

             <div class="pure-u-1 pure-u-lg-1-3"></div>
        </div>

    </div>


<div class="page-container">
    <div class="entry-content">
        <div class="post-meta pure-g">
            <div class="pure-u-3-4 meta-data">
                <a href="./category/tech.html" class="category">Tech</a><br />

                <a class="author" href="./author/shane-dowling.html">Shane Dowling</a>
                &mdash; <abbr title="2015-04-16T00:00:00+00:00">Thu 16 April 2015</abbr>
            </div>
        </div>
    </div>

    <div class="article-header-container">
        <div class="background-image-container">

            <div class="background-image-small">
                <div class="title-container">
                    <h1>SugarCRM — Prevent currencies getting overridden</h1>
                </div>
            </div>
        </div>
    </div>

    <div class="entry-content">
        <p><img alt="" src="images/1__zrzOG7L4xvFI2XJ2hB9iaA.jpeg"></p>
<p>SugarCRM has some neat features involving currency rates, but one of the
more annoying ones is that Sugar will automatically update the base rate
every time you save a record with a currency field attached. This can be
fairly annoying default behaviour if you wish to maintain the correct
record value at the time of sale.</p>
<h3>The problem</h3>
<p>Say for example you have a custom module Books and your systems base
currency is USD. You sell a book for 10 Euros at 11 dollars(the currenct
change rate). If say a few weeks later you wanted to change the status
of the Book to say, note down that the invoice was received and the
exchange rate in that time has changed drastically. When you hit save
Sugar would re-calculate the Euro value again(and despite the item being
sold for 10 Euros originally the exchange rate has now changed and Sugar
shows say 12 Euros, which is completely inconsistent with what you've
invoiced.</p>
<h3>The solution</h3>
<p>There is thankfully a way around this using by overriding Sugar's
default behaviour using logic hooks. So taking our book example this is
what custom/modules/Books/logic_hooks.php might look like.</p>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
  <span class="c1">// Do not store anything in this file that is not part of the array or the hook version.  This file will</span>
  <span class="c1">// be automatically rebuilt in the future.</span>
  <span class="nv">$hook_version</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="nv">$hook_array</span> <span class="o">=</span> <span class="k">Array</span><span class="p">();</span>
  <span class="c1">// position, file, function</span>
  <span class="nv">$hook_array</span><span class="p">[</span><span class="s1">&#39;before_save&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="k">Array</span><span class="p">();</span>
  <span class="nv">$hook_array</span><span class="p">[</span><span class="s1">&#39;before_save&#39;</span><span class="p">][]</span> <span class="o">=</span> <span class="k">Array</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;workflow&#39;</span><span class="p">,</span> <span class="s1">&#39;include/workflow/WorkFlowHandler.php&#39;</span><span class="p">,</span><span class="s1">&#39;WorkFlowHandler&#39;</span><span class="p">,</span> <span class="s1">&#39;WorkFlowHandler&#39;</span><span class="p">);</span>
  <span class="nv">$hook_array</span><span class="p">[</span><span class="s1">&#39;before_save&#39;</span><span class="p">][]</span> <span class="o">=</span> <span class="k">Array</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;Custom Book Logic Hooks&#39;</span><span class="p">,</span> <span class="s1">&#39;custom/modules/Books/logic_hooks_class.php&#39;</span><span class="p">,</span><span class="s1">&#39;books_logic_hooks&#39;</span><span class="p">,</span> <span class="s1">&#39;before_save_method&#39;</span><span class="p">);</span>
  <span class="nv">$hook_array</span><span class="p">[</span><span class="s1">&#39;after_save&#39;</span><span class="p">][]</span> <span class="o">=</span> <span class="k">Array</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;Custom Book Logic Hooks&#39;</span><span class="p">,</span> <span class="s1">&#39;custom/modules/Books/logic_hooks_class.php&#39;</span><span class="p">,</span><span class="s1">&#39;books_logic_hooks&#39;</span><span class="p">,</span> <span class="s1">&#39;after_save_method&#39;</span><span class="p">);</span>
<span class="cp">?&gt;</span><span class="x"></span>
</pre></div>


<p>And the actual code to do the overriding would be in
custom/modules/Books/logic_hooks_class.php</p>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">defined</span><span class="p">(</span><span class="s1">&#39;sugarEntry&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="nx">sugarEntry</span><span class="p">)</span> <span class="k">die</span><span class="p">(</span><span class="s1">&#39;Not A Valid Entry Point&#39;</span><span class="p">);</span>

<span class="k">class</span> <span class="nc">books_logic_hooks</span>
<span class="p">{</span>
  <span class="k">protected</span> <span class="k">static</span> <span class="nv">$fetchedRow</span><span class="p">;</span>

<span class="k">function</span> <span class="nf">before_save_method</span><span class="p">(</span><span class="o">&amp;</span><span class="nv">$bean</span><span class="p">,</span> <span class="nv">$event</span><span class="p">,</span> <span class="nv">$arguments</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$bean</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">self</span><span class="o">::</span><span class="nv">$fetchedRow</span><span class="p">[</span><span class="nv">$bean</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$bean</span><span class="o">-&gt;</span><span class="na">fetched_row</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

<span class="sd">/**</span>
<span class="sd">  * Called as process_record logic hook on the Books module</span>
<span class="sd">  */</span>

<span class="sd">/**</span>
<span class="sd">  * [@param](http://twitter.com/param &quot;Twitter profile for @param&quot;) $bean</span>
<span class="sd">  * [@param](http://twitter.com/param &quot;Twitter profile for @param&quot;) $event</span>
<span class="sd">  * [@param](http://twitter.com/param &quot;Twitter profile for @param&quot;) $arguments</span>
<span class="sd">  */</span>
  <span class="k">function</span> <span class="nf">after_save_method</span><span class="p">(</span><span class="o">&amp;</span><span class="nv">$bean</span><span class="p">,</span> <span class="nv">$event</span><span class="p">,</span> <span class="nv">$arguments</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="nv">$custom_bean</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Books</span><span class="p">();</span>
    <span class="nv">$custom_bean</span><span class="o">-&gt;</span><span class="na">retrieve</span><span class="p">(</span><span class="nv">$bean</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">);</span>
    <span class="nv">$resave_bean</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>

<span class="c1">// Need to ignore base rate updates when the currency stays the same</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nx">self</span><span class="o">::</span><span class="nv">$fetchedRow</span><span class="p">[</span><span class="nv">$custom_bean</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">][</span><span class="s1">&#39;currency_id&#39;</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nx">self</span><span class="o">::</span><span class="nv">$fetchedRow</span><span class="p">[</span><span class="nv">$custom_bean</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">][</span><span class="s1">&#39;currency_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="nv">$bean</span><span class="o">-&gt;</span><span class="na">fetched_row</span><span class="p">[</span><span class="s1">&#39;currency_id&#39;</span><span class="p">]</span>
    <span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nx">self</span><span class="o">::</span><span class="nv">$fetchedRow</span><span class="p">[</span><span class="nv">$custom_bean</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">][</span><span class="s1">&#39;base_rate&#39;</span><span class="p">])</span> <span class="o">&amp;&amp;</span>
      <span class="nx">self</span><span class="o">::</span><span class="nv">$fetchedRow</span><span class="p">[</span><span class="nv">$custom_bean</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">][</span><span class="s1">&#39;base_rate&#39;</span><span class="p">]</span> <span class="o">!=</span>     <span class="nv">$bean</span><span class="o">-&gt;</span><span class="na">fetched_row</span><span class="p">[</span><span class="s1">&#39;base_rate&#39;</span><span class="p">])</span> <span class="p">{</span>
        <span class="c1">// Run a SQL update to reset the base price to the original, as it shouldn&#39;t be over-ridden unless it&#39;s new</span>
        <span class="nv">$sql</span> <span class="o">=</span> <span class="nb">sprintf</span><span class="p">(</span><span class="s1">&#39;UPDATE books_cstm SET base_rate=&quot;%s&quot; WHERE id_c=&quot;%s&quot;;&#39;</span><span class="p">,</span> <span class="nx">self</span><span class="o">::</span><span class="nv">$fetchedRow</span><span class="p">[</span><span class="nv">$custom_bean</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">][</span><span class="s1">&#39;base_rate&#39;</span><span class="p">],</span> <span class="nv">$custom_bean</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">);</span>
        <span class="nv">$bean</span><span class="o">-&gt;</span><span class="na">db</span><span class="o">-&gt;</span><span class="na">query</span><span class="p">(</span><span class="nv">$sql</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>Using the db over-ride hack should allow you to retain the same base
rate on each record and Sugar will display the original 10 Euros despite
the exchange rate changing.</p>
<h3>Some words of caution</h3>
<p>If you decide to override Sugar's default behaviour, you could run
into some issues down the line with reporting.
Basically the reports modules seems to ignore the base rate stored on
each individual record and just uses whatever the system default is.</p>
<p>So you'll have totals in your report that will be inconsistent with the
currency value that's stored on the record. One way around this is to
only create reports using your base currency, another is to create a
secondary field storing the correct amount of the currency in a decimal
field rather than a currency field and creating reports based on that
amount.</p>
    </div>

    <footer>
        <div class="pure-g post-footer">
            <div class="pure-u-1 pure-u-md-1-2">
                <div class="pure-g poster-info">
                    <div class="pure-u-3-4">
                        <h3 class="author-name"><a href="./author/shane-dowling.html">Shane Dowling</a></h3>
                        <p class="author-description">
                        </p>
                    </div>
                </div>
            </div>



        </div>


    </footer>


</div>


    <!-- Matomo -->
        <script>
          var _paq = window._paq = window._paq || [];
          /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
          _paq.push(['trackPageView']);
          _paq.push(['enableLinkTracking']);
          (function() {
            var u="//https://stats.shanedowling.com/";
            _paq.push(['setTrackerUrl', u+'matomo.php']);
                  _paq.push(['setSiteId', '1']);
            var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
            g.async=true; g.src=u+'matomo.js'; s.parentNode.insertBefore(g,s);
          })();
        </script>
        <!-- End Matomo Code -->
</body>
</html>